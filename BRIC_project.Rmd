---
title: "BRIC_project"
author: 
  name: Manuel Schreiber
output:
  html_document:
    toc: true
    toc_float: true
    theme: united
    df_print: paged
  html_notebook: default
  latex_engine: pdflatex
  pdf_document: default
  header-includes:
   - \usepackage{amsmath}
   - \usepackage{amsfonts}
---

**BRIC Project**

```{r}
# clear workspace
##rm(list=ls())
```


getting the current WD

```{r}
getwd()
```

changing the WD

```{r}
##setwd("/Users/Manu/Desktop/TUM_Master_Mgt_Technology/TUM_SS_21/Empirical Asset Pricing seminar/Seminar Thesis/BRIC_data")
```

# Loading Libraries

```{r}
# loading libraries
library(data.table) # extension of the data.frame package. It is widely used for fast aggregation of large datasets, low latency add/update/remove of columns, quicker ordered joins, and a fast file reader.
library(dplyr) # data manipulation package
library(lubridate)
library(zoo) # methods for totally ordered indexed observations. It aims at performing calculations containing irregular time series of numeric vectors, matrices & factors

library(stats)
library(utils)

```


# Loading in the R.data

Data column descriptions (Worldscope):
https://www.professors.wi.tum.de/fileadmin/w00bca/fm/Worldscope_Data_Definition_Guide_Issue_15.pdf

https://docs.google.com/spreadsheets/d/1YtuJiv60Q6nKIaFJLQY60sGQErbsl_8nvPdUHmvO8vM/edit?usp=sharing



```{r}
# loading R.data BRIC monthly
load("/Users/Manu/Desktop/TUM_Master_Mgt_Technology/TUM_SS_21/Empirical Asset Pricing seminar/Seminar Thesis/BRIC_data/BRIC_monthly.RData")

# loading R.data BRIC monthly
load("/Users/Manu/Desktop/TUM_Master_Mgt_Technology/TUM_SS_21/Empirical Asset Pricing seminar/Seminar Thesis/BRIC_data/BRIC_static.RData")

# loading R.data BRIC monthly
load("/Users/Manu/Desktop/TUM_Master_Mgt_Technology/TUM_SS_21/Empirical Asset Pricing seminar/Seminar Thesis/BRIC_data/BRIC_yearly.RData")
```

```{r}
str(BRIC.monthly)
```

# Importing the Risk free Rate Data

download T-bill data from Kenneth French Website for the risk free rate

```{r}
# import the Kenneth/French risk free rate (1month T-bill rate)
kf_data <- read.csv("/Users/Manu/Desktop/TUM_Master_Mgt_Technology/TUM_SS_21/Empirical Asset Pricing seminar/Seminar Thesis/BRIC_data/F_F_Research_Data_Factors.csv")

kf_data

# extracting the risk free rate
one_m_tbill <- kf_data$RF


tail(kf_data)

```



```{r}
# summary stats
summary(BRIC.monthly)
```



```{r}
str(BRIC.static)
```

ISIN: International Security Identification Number (stock identifier)
ESTAT: active vs inactive company (publicly listed or not)
Id: join column with BRIC.yearly dataframe
INDM: industry sector code

GEOGN: geographic group name
GEOLN: geographic location

List of Database codes:
https://www.bwl.uni-mannheim.de/media/Lehrstuehle/bwl/Maug/Database_info/Datastream_dataypes.pdf

```{r}
str(BRIC.yearly)

head(BRIC.yearly)
```

ID: ??
Country: 4 BRIC COUNTRY CODES
ICBSUC: industrial classification benchmark
https://link.springer.com/content/pdf/bbm%3A978-3-8350-9531-1%2F1.pdf

WC07021: SIC(standard industrial classification) primary code from Worldscope
W05651: Common Shares Traded - Annual (Security)


```{r}
summary(BRIC.yearly)
```


*TO DO's*:

- Calculate Benchmark (market-cap weighted big stocks of the BRIC region)
- Calculate break points on big stocks
- decide on strategy and implement it
- calculate portfolio characteristics
- visualize and showcase strategy performance
- regress strategy PF on FF5FM and momentum for style exposure analysis
- Literature 


*Project Dates*:
Thesis submission: June 21
Final presentation: June 07

*Strategy*:
GDP weighted countries; stock level: max sharpe ratio, min volatility, equal sector weights or quotas, momentum?


EDA


```{r}
summary(BRIC.monthly$ym)
```


```{r}
# finding the number of NA values by column in the dataframe
BRIC.monthly %>% mutate_all(is.na) %>% summarize_all(sum)

```

```{r}
# finding the number of NA values by column in the dataframe
BRIC.static %>% mutate_all(is.na) %>% summarize_all(sum)
```


To DO: compute correlations by sector (10 sectors)

```{r}
# regular correlation matrix of all (four) numeric attributes
cor(select(BRIC.static, where(is.numeric)))
```


```{r}
# number of entries stocks per country
tabulate(as.factor(BRIC.monthly$country));

unique(BRIC.monthly$country)

#weight CHN 
```

```{r}
# unqiue industries
unique(BRIC.static$INDM)
# Real Estate: Residential REITs, Retail RETS, Diversified REITS, Mortgage REITS, Specialty REITS, Ind. & Office REITS
# Commodities: Iron & Steel, Commodity Chemicals, General Mining, Integrated Oil and Gas, Alternative Fuels, 
# Infrastructure: Railroads, Transportation Services, Alternative Fuels, Alt. Electricity
```

```{r}
# cross tab plot of ownership interest and certain features with legend
# cex.names: expansion factor for the axis labels
barplot(with(BRIC.static, table(INDM)), beside = TRUE, legend.text = TRUE, main = "Crosstab", cex.names = 0.4)

```



```{r}
# Market Cap values
summary(BRIC.monthly$MV.USD)
summary(BRIC.monthly$RET.USD)

```



**Some conventions:**

Characteristic should be calculated as in Hanauer & Lauterbach (2019) or in Hanauer (2020)

Big stocks should be defined as the biggest stocks which together account for 90% of a
country's aggregated market capitalization
Benchmark should be defined as the cap-weighted universe of big stocks
Returns should be in USD
Breakpoints (for Fama-French factors) should be calculated on big stocks (as in the
excursus) but both small and big stocks go into the factor calculation.

# Benchmark Calculation

```{r}
length(BRIC.static$Id)

length(BRIC.yearly$Id)

```

```{r}
# joining the monthly and the static dataframe by the Id column (retainig all rows of BRIC.yearly)
df_combined <- left_join(x=BRIC.monthly,y=BRIC.static,by="Id")


head(df_combined)



```

```{r}
summary(df_combined$MV.USD)
```


```{r}
dim(df_combined)

dim(BRIC.yearly)

dim(BRIC.static)

dim(BRIC.monthly)
```

```{r}
## finding the number of NA values by column in the dataframe
BRIC.yearly %>% mutate_all(is.na) %>% summarize_all(sum)
```



```{r}
# markt cap (USD): WC07210

## finding the number of NA values by column in the dataframe
df_combined %>% mutate_all(is.na) %>% summarize_all(sum)
```




Idea: calculate 90% of the sum of all stock market caps per country as a time series
(store the result in a column )

```{r}
# Big stocks should be defined as the biggest stocks which together account for 90% of # a country's aggregated market capitalization


# grouping the mcap values of individual stocks by country
mcap_country <- df_combined %>%
  filter(df_combined$MV.USD != "NA") %>% 
  group_by(country.x, ym) 

# computing the sum of the individual stock's market caps by country
country_mcap <- mcap_country %>%
group_by(country.x, ym) %>%
    summarize(mc_sum = sum(MV.USD))

country_mcap


```

```{r}
summary(country_mcap$mc_sum[country_mcap$country.x == "BRA"])
summary(country_mcap$mc_sum[country_mcap$country.x == "RUS"])
summary(country_mcap$mc_sum[country_mcap$country.x == "IND"])
summary(country_mcap$mc_sum[country_mcap$country.x == "CHN"])
```

# FF5FM Calulation new

```{r}
# import csv
library(readr)
FFData <- read_csv("FF_Research_Data_5_Factors_2x3.CSV", 
     skip = 2)


# adding a ym column to risk free rate data
one_m_tbill <- as.data.frame(FFData[c("X1","RF")][1:693,])

one_m_tbill$ym<-as.yearmon(one_m_tbill$X1, "%Y %m")


# merge risk-free rate (1 month treasury bill rate) with monthly data
BRIC.monthly_new <- left_join(x = BRIC.monthly, y = one_m_tbill, by = "ym")

# remove NAs from our data
## NOTE: Problem with data where there's other data but not ret.usd data --> Confirm with Hanauer and Windm√ºller

BRIC.monthly_neww <- na.omit(BRIC.monthly_new)

# make rf column numeric
BRIC.monthly_neww$RF <- as.numeric(BRIC.monthly_neww$RF)

```

# calculate RMRF

```{r}
BRIC.monthly_neww$RMRF <- BRIC.monthly_neww$RET.USD - BRIC.monthly_neww$RF
```

# Calculate SMB
comment: na values appear for size calculation, which differs from what in the excursus
note: we omitted the na's for further calculation --> has to be clarified in the Q&A session with Hanauer

```{r}
## Determine portfolio breakpoints for Size
# Fama-French take the MV from end-of-June and rebalance yearly
BRIC.monthly_neww[,month := month(Date)]
BRIC.monthly_neww[,year := year(Date)]
BRIC.monthly_neww[,hcjun := ifelse(month>=7,year,year-1)]

# determine size portfolio allocation from July on using data that's public from end-of-June on
setorder(BRIC.monthly_neww,Date,-MV.USD)
hlpvariable <-  BRIC.monthly_neww[month==7 & !is.na(MV.USD),
                .(Size = ifelse((cumsum(MV.USD)/sum(MV.USD))>=0.9,"Small","Big"),Id),
                               by=year]

# Merge the size portfolio allocation back from July Y to June Y+1
panel_country <- merge(BRIC.monthly_neww,hlpvariable,
                       by.x=c("hcjun","Id"),
                       by.y=c("year","Id"),
                       all.x=T)

panel_country_noNA <- na.omit(SMB_Calculation) 

# to do: 
# merge yearly BM data with our table
BRIC.yearly_helper <- subset( BRIC.yearly, select = c("Id","country","ICBSUC","YEAR","WC03501","WC07210") )
BRIC.yearly_helper$BM <- BRIC.yearly_helper$WC03501 / BRIC.yearly_helper$WC07210

summary(BRIC.yearly_helper$BM)

panel_country_BM <- left_join(x = panel_country_noNA,y = BRIC.yearly, by = "Id")


# Determine the B/M breakpoints based on big stocks only
hlpvariable2 <- panel_country[month==7 & !is.na(BM) & pf.size=="Big", .(bm_bb30 = quantile(BM , probs = c(0.3), na.rm=T),
                                                                        bm_bb70 = quantile(BM , probs = c(0.7), na.rm=T)),by=year]
              
# Merge the B/M portfolio allocation back from July Y to June Y+1
panel_country <- merge(panel_country,hlpvariable2,
                       by.x=c("hcjun"),
                       by.y=c("year"),
                       all.x=T)

 
```
 

```{r}
# sorting the stocks by market cap and extracting the ISINs of the biggest ones that make up 90% of a country's market cap

# RUSSIA
# 90% of the market cap in Russia: 
0.9*country_mcap$mc_sum[4]

# subsetting all Russian stocks
russian_stocks <- as.data.frame(mcap_country) %>%
   filter(country.x == "RUS") 

# sorting the dataframe of russian stocks by decreasing market cap
russian_stocks <- russian_stocks[order(russian_stocks$WC07210,decreasing = TRUE),]
 
# filtering out the big stocks which sum up to 90% of the market cap of Russian stocks
big_stocks_RUS <- russian_stocks[cumsum(russian_stocks$WC07210) <= 0.9*country_mcap$mc_sum[4],]

big_stocks_RUS



```


idea:

big_stocks <- mcap_country %>%
  select(ISIN) %>%
 sort(mcap_country$WC07210, decreasing=T)  %>%
  filter(mcap_country$WC07210 <= 0.9*country_mcap$mc_sum)

big_stocks

```{r}
# sorting the stocks by market cap and extracting the ISINs of the biggest ones that make up 90% of a country's market cap

# RUSSIA
# 90% of the market cap in Russia: 
0.9*country_mcap$mc_sum[4]

# subsetting all Russian stocks
russian_stocks <- as.data.frame(mcap_country) %>%
   filter(country.x == "RUS") 

# sorting the dataframe of russian stocks by decreasing market cap
russian_stocks <- russian_stocks[order(russian_stocks$WC07210,decreasing = TRUE),]
 
# filtering out the big stocks which sum up to 90% of the market cap of Russian stocks
big_stocks_RUS <- russian_stocks[cumsum(russian_stocks$WC07210) <= 0.9*country_mcap$mc_sum[4],]

big_stocks_RUS



  
```


```{r}
### Attempt ###


## Determine portfolio breakpoints for Size
# Fama-French take the MV from end-of-June and rebalance yearly
df_combined[,month := month(Date)]
df_combined[,year := year(Date)]
df_combined[,hcjun := ifelse(month>=7,year,year-1)]

# determine size portfolio allocation from July on using data that's public from end-of-June on
setorder(df_combined,Date,-MV.USD)
hlpvariable <-  df_combined[month==7 & !is.na(MV.USD),
                .(pf.size = ifelse((cumsum(MV.USD)/sum(MV.USD))>=0.9,"Small","Big"),Id),
                               by=year]

# Merge the size portfolio allocation back from July Y to June Y+1
panel_country <- merge(df_combined,hlpvariable,
                       by.x=c("hcjun","Id"),
                       by.y=c("year","Id"),
                       all.x=T)

panel_country



### Attempt end ###
```



# Calculating the size portfolios




